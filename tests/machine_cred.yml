---
- hosts: all

  pre_tasks:
    - name: Initiate TempFile Module for SSH Private Key
      tempfile:
        state: file
        suffix: key
      register: temp_key
      no_log: yes

    - name: Write SSH Private Key to TempFile
      copy:
        dest: "{{ temp_key.path }}"
        content: "{{ lookup('cyberark.conjur.conjur_variable', 'SyncVault/LOB_CD/D-Nix-AWS-EC2-Keypairs/Operating System-UnixSSHKeys-' + inventory_hostname + '-ec2-user/password') }}"
      changed_when: false
      no_log: yes
    
    - name: Set SSH Private Key Path to Fact
      set_fact:
        ansible_ssh_private_key_file: "{{ temp_key.path }}"

  tasks:
    - debug:
        var: test_hostname
    - debug:
        var: ansible_user